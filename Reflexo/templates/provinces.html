{% extends 'base.html' %}

{% block title %}Provincias - Sistema de Ubigeo{% endblock %}

{% block content %}
<div class="main-container">
    <h2 class="mb-4">
        <i class="fas fa-map-marker-alt text-info me-2"></i>
        Provincias
    </h2>

    <input type="text" id="busqueda" class="form-control mb-3" placeholder="Buscar por ID, nombre o código...">

    <!-- Formulario para crear provincia (ahora arriba) -->
    <form id="province-form" class="row g-2 mb-4" autocomplete="off">
        <div class="col-md-4">
            <input
                type="text"
                name="name"
                class="form-control"
                placeholder="Nombre de la provincia"
                required
                aria-label="Nombre de la provincia"
            >
        </div>
        <div class="col-md-4">
            <input
                type="text"
                name="ubigeo_code"
                class="form-control"
                placeholder="Código ubigeo"
                required
                aria-label="Código ubigeo"
            >
        </div>
        <div class="col-md-4">
            <select
                name="region_id"
                class="form-control"
                required
                aria-label="Seleccione región"
            >
                <option value="" disabled selected>Seleccione región</option>
                {% for region in regions %}
                <option value="{{ region.id }}">{{ region.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 mt-3">
            <button type="submit" class="btn btn-success w-100">Crear Provincia</button>
        </div>
    </form>

    <table class="table table-hover" id="provinces-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Código Ubigeo</th>
                <th>Nombre</th>
                <th>Región</th>
                <th>Última modificación</th>
                <th>Editar</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody>
            {% for province in provinces %}
            <tr>
                <td>{{ province.id }}</td>
                <td>{{ province.ubigeo_code }}</td>
                <td>{{ province.name }}</td>
                <td>{{ province.region.name }}</td>
                <td>
                    {% if province.updated_at %}
                        {{ province.updated_at|date:"d/m/Y H:i" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <button
                        type="button"
                        class="btn btn-sm btn-warning"
                        onclick="editProvince({{ province.id }}, '{{ province.name|escapejs }}', '{{ province.ubigeo_code|default_if_none:''|escapejs }}', {{ province.region.id }})"
                    >
                        Editar
                    </button>
                </td>
                <td>
                    <button
                        type="button"
                        class="btn btn-sm btn-danger"
                        onclick="deleteProvince({{ province.id }})"
                    >
                        Eliminar
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">No hay provincias registradas.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal para editar provincia -->
<div
    id="edit-province-modal"
    style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000; max-width:400px; width:90%;"
    role="dialog"
    aria-modal="true"
    aria-labelledby="editProvinceTitle"
>
  <h4 id="editProvinceTitle">Editar Provincia</h4>
  <form id="edit-province-form" autocomplete="off">
    <input type="hidden" name="id" id="edit-province-id">
    <div class="mb-2">
      <input
        type="text"
        name="name"
        id="edit-province-name"
        class="form-control"
        placeholder="Nombre de la provincia"
        required
        aria-label="Nombre de la provincia"
      >
    </div>
    <div class="mb-2">
      <input
        type="text"
        name="ubigeo_code"
        id="edit-province-code"
        class="form-control"
        placeholder="Código ubigeo"
        required
        aria-label="Código ubigeo"
      >
    </div>
    <div class="mb-2">
      <select
        name="region_id"
        id="edit-province-region"
        class="form-control"
        required
        aria-label="Seleccione región"
      >
        <option value="" disabled>Seleccione región</option>
        {% for region in regions %}
        <option value="{{ region.id }}">{{ region.name }}</option>
        {% endfor %}
      </select>
    </div>
    <button type="submit" class="btn btn-primary">Guardar cambios</button>
    <button type="button" class="btn btn-secondary" onclick="closeEditProvinceModal()">Cancelar</button>
  </form>
</div>

<script>
// Crear provincia
document.getElementById('province-form').addEventListener('submit', function(e) {
  e.preventDefault();
  fetchWithCSRF('/api/v3/provinces/create/', {
    method: 'POST',
    body: JSON.stringify({
      name: e.target.name.value.trim(),
      ubigeo_code: e.target.ubigeo_code.value.trim(),
      region_id: e.target.region_id.value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showMessage('Provincia creada exitosamente');
      location.reload();
    } else {
      showMessage(data.error || 'Error al crear provincia', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showMessage('Error de conexión al crear provincia', true);
  });
});

// Buscar provincias (filtro)
document.getElementById('busqueda').addEventListener('input', function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll('#provinces-table tbody tr');
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(filter) ? '' : 'none';
  });
});

function editProvince(id, name, code, region_id) {
  document.getElementById('edit-province-id').value = id;
  document.getElementById('edit-province-name').value = name;
  document.getElementById('edit-province-code').value = code;
  document.getElementById('edit-province-region').value = region_id;
  document.getElementById('edit-province-modal').style.display = 'block';
}

function closeEditProvinceModal() {
  document.getElementById('edit-province-modal').style.display = 'none';
}

document.getElementById('edit-province-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const id = document.getElementById('edit-province-id').value;
  fetchWithCSRF(`/api/v3/provinces/${id}/update/`, {
    method: 'PUT',
    body: JSON.stringify({
      name: document.getElementById('edit-province-name').value.trim(),
      ubigeo_code: document.getElementById('edit-province-code').value.trim(),
      region_id: document.getElementById('edit-province-region').value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showMessage('Provincia actualizada exitosamente');
      closeEditProvinceModal();
      location.reload();
    } else {
      showMessage(data.error || 'Error al actualizar provincia', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showMessage('Error de conexión al actualizar provincia', true);
  });
});

function deleteProvince(id) {
  if (!confirm('¿Seguro que deseas eliminar esta provincia?')) return;
  fetchWithCSRF(`/api/v3/provinces/${id}/delete/`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showMessage('Provincia eliminada exitosamente');
      location.reload();
    } else {
      showMessage(data.error || 'Error al eliminar provincia', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showMessage('Error de conexión al eliminar provincia', true);
  });
}
</script>
{% endblock %}
