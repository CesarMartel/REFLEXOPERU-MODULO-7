{% extends 'base.html' %}

{% block title %}Países - Sistema de Ubigeo{% endblock %}

{% block content %}
<div class="main-container">
    <h2 class="mb-4">
        <i class="fas fa-globe text-primary me-2"></i>
        Países
    </h2>

    <input type="text" id="busqueda" class="form-control mb-3" placeholder="Buscar por ID, nombre o código...">

    <!-- Formulario para crear país -->
    <form id="country-form" class="row g-2 mb-4">
        <div class="col-md-4">
            <input type="text" name="name" class="form-control" placeholder="Nombre del país" required>
        </div>
        <div class="col-md-4">
            <input type="text" name="ubigeo_code" class="form-control" placeholder="Código ubigeo" required>
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">Crear País</button>
        </div>
    </form>

    <!-- Tabla de países -->
    <table class="table table-hover" id="countries-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Código Ubigeo</th>
                <th>Nombre</th>
                <th>Última modificación</th>
                <th>Editar</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody>
            {% for country in countries %}
            <tr>
                <td>{{ country.id }}</td>
                <td>{{ country.ubigeo_code }}</td>
                <td>{{ country.name }}</td>
                <td>
                  {% if country.updated_at %}
                    {{ country.updated_at|date:"d/m/Y H:i" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editCountry({{ country.id }}, '{{ country.name|escapejs }}', '{{ country.ubigeo_code|default_if_none:''|escapejs }}')">Editar</button>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteCountry({{ country.id }})">Eliminar</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center text-muted">No hay países registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal para editar país -->
<div id="edit-country-modal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
  <h4>Editar País</h4>
  <form id="edit-country-form">
    <input type="hidden" name="id" id="edit-country-id">
    <div class="mb-2">
      <input type="text" name="name" id="edit-country-name" class="form-control" placeholder="Nombre del país" required>
    </div>
    <div class="mb-2">
      <input type="text" name="ubigeo_code" id="edit-country-code" class="form-control" placeholder="Código ubigeo" required>
    </div>
    <button type="submit" class="btn btn-primary">Guardar cambios</button>
    <button type="button" class="btn btn-secondary" onclick="closeEditCountryModal()">Cancelar</button>
  </form>
</div>

<script>
// Crear país
document.getElementById('country-form').addEventListener('submit', function(e) {
  e.preventDefault();
  apiPost('/api/v3/countries/create/', {
    name: e.target.name.value,
    ubigeo_code: e.target.ubigeo_code.value
  })
  .then(response => {
    const data = response.data;
    if (data.success) {
      showMessage('País creado exitosamente');
      location.reload();
    } else {
      showMessage(data.error || 'Error al crear país', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // El error ya se maneja globalmente en el interceptor
  });
});

// Editar país
function editCountry(id, name, code) {
  document.getElementById('edit-country-id').value = id;
  document.getElementById('edit-country-name').value = name;
  document.getElementById('edit-country-code').value = code;
  document.getElementById('edit-country-modal').style.display = 'block';
}

function closeEditCountryModal() {
  document.getElementById('edit-country-modal').style.display = 'none';
}

document.getElementById('edit-country-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const id = document.getElementById('edit-country-id').value;
  apiPut(`/api/v3/countries/${id}/update/`, {
    name: document.getElementById('edit-country-name').value,
    ubigeo_code: document.getElementById('edit-country-code').value
  })
  .then(response => {
    const data = response.data;
    if (data.success) {
      showMessage('País actualizado exitosamente');
      closeEditCountryModal();
      location.reload();
    } else {
      showMessage(data.error || 'Error al actualizar país', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // El error ya se maneja globalmente en el interceptor
  });
});

// Eliminar país
function deleteCountry(id) {
  if (!confirm('¿Seguro que deseas eliminar este país?')) return;
  apiDelete(`/api/v3/countries/${id}/delete/`)
  .then(response => {
    const data = response.data;
    if (data.success) {
      showMessage('País eliminado exitosamente');
      location.reload();
    } else {
      showMessage(data.error || 'Error al eliminar país', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // El error ya se maneja globalmente en el interceptor
  });
}
</script>
{% endblock %}




