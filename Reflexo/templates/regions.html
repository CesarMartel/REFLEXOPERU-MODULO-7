{% extends 'base.html' %}

{% block title %}Regiones - Sistema de Ubigeo{% endblock %}

{% block content %}
<div class="main-container">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-map text-success me-2"></i>
                Regiones
            </h2>
        </div>
    </div>

    <input type="text" id="busqueda" class="form-control mb-3" placeholder="Buscar por ID, nombre o código...">

    <!-- Formulario para crear región (ahora arriba) -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card p-3">
                <form id="region-form" class="row g-2">
                    <div class="col-md-5">
                        <input type="text" name="name" class="form-control" placeholder="Nombre de la región" required>
                    </div>
                    <div class="col-md-5">
                        <input type="text" name="ubigeo_code" class="form-control" placeholder="Código ubigeo" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-success w-100">Crear Región</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Información de depuración -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <strong>Información de depuración:</strong>
                <br>Total de regiones: {{ regions.count }}
                <br>Regiones con datos: {% if regions %}Sí{% else %}No{% endif %}
            </div>
        </div>
    </div>

    <!-- Tabla de regiones -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="data-table">
                        <table class="table table-hover" id="region-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Código Ubigeo</th>
                                    <th>Nombre</th>
                                    <th>Estado</th>
                                    <th>Última modificación</th>
                                    <th>Editar</th>
                                    <th>Eliminar</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for region in regions %}
                                <tr>
                                    <td>{{ region.id }}</td>
                                    <td>
                                        {% if region.ubigeo_code %}
                                            <span class="badge bg-primary">{{ region.ubigeo_code }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">Sin código</span>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ region.name }}</strong></td>
                                    <td>
                                        {% if region.deleted_at %}
                                            <span class="badge bg-danger">Eliminado</span>
                                        {% else %}
                                            <span class="badge bg-success">Activo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if region.updated_at %}
                                            {{ region.updated_at|date:"d/m/Y H:i" }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="editRegion({{ region.id }}, '{{ region.name|escapejs }}', '{{ region.ubigeo_code|default_if_none:''|escapejs }}')">Editar</button>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRegion({{ region.id }})">Eliminar</button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <div class="py-4">
                                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                                            <br>
                                            <strong>No hay regiones registradas</strong>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar región -->
<div id="edit-region-modal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
  <h4>Editar Región</h4>
  <form id="edit-region-form">
    <input type="hidden" name="id" id="edit-region-id">
    <div class="mb-2">
      <input type="text" name="name" id="edit-region-name" class="form-control" placeholder="Nombre de la región" required>
    </div>
    <div class="mb-2">
      <input type="text" name="ubigeo_code" id="edit-region-code" class="form-control" placeholder="Código ubigeo" required>
    </div>
    <button type="submit" class="btn btn-primary">Guardar cambios</button>
    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
  </form>
</div>

<script>
// Crear región
document.getElementById('region-form').addEventListener('submit', function(e) {
  e.preventDefault();
  apiPost('/api/v3/regions/create/', {
    name: e.target.name.value,
    ubigeo_code: e.target.ubigeo_code.value
  })
  .then(response => {
    const data = response.data;
    if (data.success) {
      showMessage('Región creada exitosamente');
      location.reload();
    } else {
      showMessage(data.error || 'Error al crear región', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // El error ya se maneja globalmente en el interceptor
  });
});

// Filtrar tabla en cliente
document.getElementById('busqueda').addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll('#region-table tbody tr');
  rows.forEach(row => {
    const id = row.cells[0]?.innerText.toLowerCase() || '';
    const codigo = row.cells[1]?.innerText.toLowerCase() || '';
    const nombre = row.cells[2]?.innerText.toLowerCase() || '';
    row.style.display = (id.includes(filter) || codigo.includes(filter) || nombre.includes(filter)) ? '' : 'none';
  });
});

// Modal edición
function editRegion(id, name, code) {
  document.getElementById('edit-region-id').value = id;
  document.getElementById('edit-region-name').value = name;
  document.getElementById('edit-region-code').value = code;
  document.getElementById('edit-region-modal').style.display = 'block';
}

function closeEditModal() {
  document.getElementById('edit-region-modal').style.display = 'none';
}

document.getElementById('edit-region-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const id = document.getElementById('edit-region-id').value;
  apiPut(`/api/v3/regions/${id}/update/`, {
    name: document.getElementById('edit-region-name').value,
    ubigeo_code: document.getElementById('edit-region-code').value
  })
  .then(response => {
    const data = response.data;
    if (data.success) {
      showMessage('Región actualizada exitosamente');
      closeEditModal();
      location.reload();
    } else {
      showMessage(data.error || 'Error al actualizar región', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // El error ya se maneja globalmente en el interceptor
  });
});

// Eliminar
function deleteRegion(id) {
  if (!confirm('¿Seguro que deseas eliminar esta región?')) return;
  apiDelete(`/api/v3/regions/${id}/delete/`)
  .then(response => {
    const data = response.data;
    if (data.success) {
      showMessage('Región eliminada exitosamente');
      location.reload();
    } else {
      showMessage(data.error || 'Error al eliminar región', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // El error ya se maneja globalmente en el interceptor
  });
}
</script>
{% endblock %}